name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip Alembic migrations'
        required: false
        type: boolean
        default: false

env:
  GCP_REGION: ${{ vars.GCP_REGION }}
  ARTIFACT_REGISTRY: ${{ vars.ARTIFACT_REGISTRY }}
  PROD_PROJECT_ID: ${{ vars.PROD_PROJECT_ID }}

jobs:
  require-dev-success:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Ensure dev deploy succeeded for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const defaultBranch = context.payload.repository.default_branch;
            const refName = context.ref_name;
            if (refName !== defaultBranch) {
              core.setFailed(`Deploy to Production must be run from ${defaultBranch}. Current ref: ${refName}`);
              return;
            }

            const { data } = await github.rest.actions.listWorkflowRunsForWorkflow({
              owner,
              repo,
              workflow_id: 'deploy-dev.yml',
              branch: defaultBranch,
              status: 'completed',
              per_page: 50,
            });

            const successForSha = data.workflow_runs.find(
              (run) => run.head_sha === context.sha && run.conclusion === 'success'
            );

            if (!successForSha) {
              const latestSuccess = data.workflow_runs.find(
                (run) => run.conclusion === 'success'
              );
              const latestDesc = latestSuccess
                ? `${latestSuccess.head_sha.slice(0, 7)} (${latestSuccess.html_url})`
                : 'none';
              core.setFailed(
                `Deploy to Dev has not succeeded for ${context.sha}. Latest successful dev deploy: ${latestDesc}. Run Deploy to Dev on this commit before deploying to prod.`
              );
            }

  # Build & push backend image (prod)
  build-backend-prod:
    needs: require-dev-success
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.image.outputs.name }}

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ vars.GCP_SA_TERRAFORM_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}

      - name: Build and push
        id: image
        run: |
          IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/backend:${{ github.sha }}"
          docker build -t $IMAGE -f backend/Dockerfile backend
          docker push $IMAGE
          echo "name=$IMAGE" >> $GITHUB_OUTPUT

  # Build & push frontend image (prod)
  build-frontend-prod:
    needs: require-dev-success
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.image.outputs.name }}

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ vars.GCP_SA_TERRAFORM_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}

      - name: Build and push
        id: image
        run: |
          IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/frontend:${{ github.sha }}"
          docker build -t $IMAGE -f frontend/Dockerfile \
            --build-arg VITE_ASSET_BUCKET=${{ vars.VITE_ASSET_BUCKET_PROD }} \
            frontend
          docker push $IMAGE
          echo "name=$IMAGE" >> $GITHUB_OUTPUT

  # Terraform apply to prod
  terraform-apply-prod:
    needs: [build-backend-prod, build-frontend-prod]
    runs-on: ubuntu-latest
    environment: prod  # Requires manual approval in GitHub
    permissions:
      contents: read
      id-token: write
    outputs:
      backend_url: ${{ steps.outputs.outputs.backend_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ vars.GCP_SA_TERRAFORM_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve image tags
        run: |
          echo "BACKEND_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "FRONTEND_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false

      - name: Terraform init
        run: |
          cd infra/terraform/envs/prod
          terraform init

      - name: Terraform plan
        run: |
          cd infra/terraform/envs/prod
          terraform plan \
            -var="project_id=${{ env.PROD_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -var="vertex_region=${{ vars.VERTEX_REGION || env.GCP_REGION }}" \
            -var="backend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/backend:${{ env.BACKEND_TAG }}" \
            -var="frontend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/frontend:${{ env.FRONTEND_TAG }}"

      - name: Terraform apply
        run: |
          cd infra/terraform/envs/prod
          terraform apply -auto-approve \
            -var="project_id=${{ env.PROD_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -var="vertex_region=${{ vars.VERTEX_REGION || env.GCP_REGION }}" \
            -var="backend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/backend:${{ env.BACKEND_TAG }}" \
            -var="frontend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/frontend:${{ env.FRONTEND_TAG }}"

      - name: Get outputs
        id: outputs
        run: |
          cd infra/terraform/envs/prod
          BACKEND_URL=$(terraform output -raw backend_url)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT

  # Run Alembic migrations against prod Cloud SQL
  run-migrations-prod:
    needs: terraform-apply-prod
    if: ${{ !inputs.skip_migrations }}
    runs-on: ubuntu-latest
    environment: prod  # Reuse prod environment approval for migrations
    permissions:
      contents: read
      id-token: write
    env:
      MODE: production
      PROJECT_NAME: fastapi-sqlmodel-alembic
      OPENAI_API_KEY: dummy
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      BACKEND_CORS_ORIGINS: http://localhost

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ vars.GCP_SA_TERRAFORM_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip uv
          cd backend/app
          uv sync --frozen --no-install-project

      - name: Start Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ vars.PROD_SQL_INSTANCE_CONNECTION }}=tcp:5432 &
          sleep 5

      - name: Fetch DB password from Secret Manager
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret="db-password" --project="${{ env.PROD_PROJECT_ID }}")
          ENCRYPT_KEY=$(gcloud secrets versions access latest --secret="encrypt-key" --project="${{ env.PROD_PROJECT_ID }}")
          echo "DATABASE_USER=${{ vars.PROD_DB_USER }}" >> $GITHUB_ENV
          echo "DATABASE_PASSWORD=${DB_PASSWORD}" >> $GITHUB_ENV
          echo "DATABASE_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "DATABASE_PORT=5432" >> $GITHUB_ENV
          echo "DATABASE_NAME=${{ vars.PROD_DB_NAME }}" >> $GITHUB_ENV
          echo "ENCRYPT_KEY=${ENCRYPT_KEY}" >> $GITHUB_ENV

      - name: Extract Cloud SQL instance name
        run: |
          INSTANCE="${{ vars.PROD_SQL_INSTANCE_CONNECTION }}"
          echo "DB_INSTANCE=${INSTANCE##*:}" >> $GITHUB_ENV

      - name: Backup notification
        continue-on-error: true
        run: |
          echo "Ensure a recent DB backup exists before proceeding"
          gcloud sql backups list --instance="$DB_INSTANCE" --limit=1

      - name: Run migrations
        run: |
          cd backend/app
          uv run alembic upgrade head

      - name: Verify migration
        run: |
          cd backend/app
          uv run alembic current

  # Smoke test prod deployment
  smoke-test-prod:
    needs: [terraform-apply-prod, run-migrations-prod]
    if: always() && needs.terraform-apply-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Health check
        run: |
          BACKEND_URL="${{ needs.terraform-apply-prod.outputs.backend_url }}"
          curl -f "$BACKEND_URL/health" || exit 1
          echo "Production deployment healthy"

      - name: Notify success
        run: |
          echo "Production deployed successfully"
          echo "Backend: ${{ needs.terraform-apply-prod.outputs.backend_url }}"

  notify-prod-success:
    needs: [terraform-apply-prod, smoke-test-prod]
    if: always() && needs.smoke-test-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Send Google Chat success notification
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_WEBHOOK_PROD }}
          jobStatus: success
          title: "üéâ Production Deployment Successful"
          subtitle: "All systems operational"
          additionalSections: |
            [
              {
                "header": "üì¶ Deployed",
                "widgets": [
                  {
                    "decoratedText": {
                      "topLabel": "Backend Image",
                      "text": "${{ env.BACKEND_TAG }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Frontend Image",
                      "text": "${{ env.FRONTEND_TAG }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Deployed By",
                      "text": "${{ github.actor }}"
                    }
                  }
                ]
              },
              {
                "widgets": [
                  {
                    "buttonList": {
                      "buttons": [
                        {
                          "text": "View Production",
                          "onClick": {
                            "openLink": {
                              "url": "${{ needs.terraform-apply-prod.outputs.backend_url }}"
                            }
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            ]

  notify-prod-failure:
    needs: [terraform-apply-prod, run-migrations-prod, smoke-test-prod]
    if: always() && (needs.terraform-apply-prod.result == 'failure' || needs.run-migrations-prod.result == 'failure' || needs.smoke-test-prod.result == 'failure')
    runs-on: ubuntu-latest

    steps:
      - name: Send Google Chat failure alert
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_WEBHOOK_PROD }}
          jobStatus: failure
          title: "üö® Production Deployment FAILED"
          subtitle: "<users/all> Immediate action required"
          # mention: "<users/all>"
          additionalSections: |
            [
              {
                "header": "‚ùå Failed Stage",
                "widgets": [
                  {
                    "decoratedText": {
                      "topLabel": "Terraform",
                      "text": "${{ needs.terraform-apply-prod.result }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Migrations",
                      "text": "${{ needs.run-migrations-prod.result }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Smoke Test",
                      "text": "${{ needs.smoke-test-prod.result }}"
                    }
                  }
                ]
              },
              {
                "widgets": [
                  {
                    "buttonList": {
                      "buttons": [
                        {
                          "text": "View Failure Logs",
                          "onClick": {
                            "openLink": {
                              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                            }
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            ]

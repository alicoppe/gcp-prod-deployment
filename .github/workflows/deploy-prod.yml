name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      backend_image_tag:
        description: 'Backend image SHA (from dev build)'
        required: true
        type: string
      frontend_image_tag:
        description: 'Frontend image SHA (from dev build)'
        required: true
        type: string
      skip_migrations:
        description: 'Skip Alembic migrations'
        required: false
        type: boolean
        default: false

env:
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
  PROD_PROJECT_ID: prod-deployment-483516

jobs:
  # Terraform apply to prod
  terraform-apply-prod:
    runs-on: ubuntu-latest
    environment: prod  # Requires manual approval in GitHub
    permissions:
      contents: read
      id-token: write
    outputs:
      backend_url: ${{ steps.outputs.outputs.backend_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ secrets.GCP_SA_TERRAFORM_PROD }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false

      - name: Terraform init
        run: |
          cd infra/terraform/envs/prod
          terraform init

      - name: Terraform plan
        run: |
          cd infra/terraform/envs/prod
          terraform plan \
            -var="backend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/backend:${{ inputs.backend_image_tag }}" \
            -var="frontend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/frontend:${{ inputs.frontend_image_tag }}"

      - name: Terraform apply
        run: |
          cd infra/terraform/envs/prod
          terraform apply -auto-approve \
            -var="backend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/backend:${{ inputs.backend_image_tag }}" \
            -var="frontend_image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROD_PROJECT_ID }}/app/frontend:${{ inputs.frontend_image_tag }}"

      - name: Get outputs
        id: outputs
        run: |
          cd infra/terraform/envs/prod
          BACKEND_URL=$(terraform output -raw backend_url)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT

  # Run Alembic migrations against prod Cloud SQL
  run-migrations-prod:
    needs: terraform-apply-prod
    if: ${{ !inputs.skip_migrations }}
    runs-on: ubuntu-latest
    environment: prod  # Reuse prod environment approval for migrations
    permissions:
      contents: read
      id-token: write
    env:
      MODE: production
      PROJECT_NAME: fastapi-sqlmodel-alembic
      OPENAI_API_KEY: dummy
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      FIRST_SUPERUSER_EMAIL: admin@example.com
      FIRST_SUPERUSER_PASSWORD: admin
      WHEATER_URL: https://wttr.in
      BACKEND_CORS_ORIGINS: http://localhost

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER_PROD }}
          service_account: ${{ secrets.GCP_SA_MIGRATION_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip poetry
          cd backend/app
          poetry install --no-root --only main

      - name: Start Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.PROD_SQL_INSTANCE_CONNECTION }}=tcp:5432 &
          sleep 5

      - name: Parse database URL
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          python - <<'PY'
          import os
          from urllib.parse import urlparse, unquote

          url = os.environ["DATABASE_URL"]
          parsed = urlparse(url)
          user = unquote(parsed.username or "")
          password = unquote(parsed.password or "")
          host = parsed.hostname or ""
          port = parsed.port or 5432
          db = (parsed.path or "").lstrip("/")

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"DATABASE_USER={user}\n")
              f.write(f"DATABASE_PASSWORD={password}\n")
              f.write(f"DATABASE_HOST={host}\n")
              f.write(f"DATABASE_PORT={port}\n")
              f.write(f"DATABASE_NAME={db}\n")
          PY

      - name: Extract Cloud SQL instance name
        run: |
          INSTANCE="${{ secrets.PROD_SQL_INSTANCE_CONNECTION }}"
          echo "DB_INSTANCE=${INSTANCE##*:}" >> $GITHUB_ENV

      - name: Backup notification
        continue-on-error: true
        run: |
          echo "Ensure a recent DB backup exists before proceeding"
          gcloud sql backups list --instance="$DB_INSTANCE" --limit=1

      - name: Run migrations
        run: |
          cd backend/app
          poetry run alembic upgrade head

      - name: Verify migration
        run: |
          cd backend/app
          poetry run alembic current

  # Smoke test prod deployment
  smoke-test-prod:
    needs: [terraform-apply-prod, run-migrations-prod]
    if: always() && needs.terraform-apply-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Health check
        run: |
          BACKEND_URL="${{ needs.terraform-apply-prod.outputs.backend_url }}"
          curl -f "$BACKEND_URL/health" || exit 1
          echo "Production deployment healthy"

      - name: Notify success
        run: |
          echo "Production deployed successfully"
          echo "Backend: ${{ needs.terraform-apply-prod.outputs.backend_url }}"

  notify-prod-success:
    needs: [terraform-apply-prod, smoke-test-prod]
    if: always() && needs.smoke-test-prod.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Send Google Chat success notification
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_WEBHOOK_PROD }}
          jobStatus: success
          title: "üéâ Production Deployment Successful"
          subtitle: "All systems operational"
          additionalSections: |
            [
              {
                "header": "üì¶ Deployed",
                "widgets": [
                  {
                    "decoratedText": {
                      "topLabel": "Backend Image",
                      "text": "${{ inputs.backend_image_tag }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Frontend Image",
                      "text": "${{ inputs.frontend_image_tag }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Deployed By",
                      "text": "${{ github.actor }}"
                    }
                  }
                ]
              },
              {
                "widgets": [
                  {
                    "buttonList": {
                      "buttons": [
                        {
                          "text": "View Production",
                          "onClick": {
                            "openLink": {
                              "url": "${{ needs.terraform-apply-prod.outputs.backend_url }}"
                            }
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            ]

  notify-prod-failure:
    needs: [terraform-apply-prod, run-migrations-prod, smoke-test-prod]
    if: always() && (needs.terraform-apply-prod.result == 'failure' || needs.run-migrations-prod.result == 'failure' || needs.smoke-test-prod.result == 'failure')
    runs-on: ubuntu-latest

    steps:
      - name: Send Google Chat failure alert
        uses: SimonScholz/google-chat-action@main
        with:
          webhookUrl: ${{ secrets.GOOGLE_CHAT_WEBHOOK_PROD }}
          jobStatus: failure
          title: "üö® Production Deployment FAILED"
          subtitle: "<users/all> Immediate action required"
          # mention: "<users/all>"
          additionalSections: |
            [
              {
                "header": "‚ùå Failed Stage",
                "widgets": [
                  {
                    "decoratedText": {
                      "topLabel": "Terraform",
                      "text": "${{ needs.terraform-apply-prod.result }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Migrations",
                      "text": "${{ needs.run-migrations-prod.result }}"
                    }
                  },
                  {
                    "decoratedText": {
                      "topLabel": "Smoke Test",
                      "text": "${{ needs.smoke-test-prod.result }}"
                    }
                  }
                ]
              },
              {
                "widgets": [
                  {
                    "buttonList": {
                      "buttons": [
                        {
                          "text": "View Failure Logs",
                          "onClick": {
                            "openLink": {
                              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                            }
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            ]
